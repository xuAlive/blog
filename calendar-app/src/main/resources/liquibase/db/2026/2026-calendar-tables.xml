<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <!-- 创建事件表 -->
    <changeSet id="2026-cal-001" author="calendar-app">
        <createTable tableName="calendar_event" remarks="事件/记事表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account" type="VARCHAR(50)" remarks="用户账号">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(200)" remarks="事件标题">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="TEXT" remarks="事件内容/记事详情"/>
            <column name="event_date" type="DATE" remarks="事件日期">
                <constraints nullable="false"/>
            </column>
            <column name="event_time" type="TIME" remarks="事件时间(可为空)"/>
            <column name="event_type" type="TINYINT" defaultValue="1" remarks="类型: 1-待办 2-记事 3-纪念日"/>
            <column name="status" type="TINYINT" defaultValue="1" remarks="状态: 1-待完成 2-已完成 3-已过期"/>
            <column name="priority" type="TINYINT" defaultValue="2" remarks="优先级: 1-低 2-中 3-高"/>
            <column name="tags" type="VARCHAR(500)" remarks="标签(JSON数组)"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="更新时间"/>
            <column name="is_delete" type="TINYINT" defaultValue="0" remarks="删除标记"/>
        </createTable>

        <!-- 添加索引 -->
        <createIndex tableName="calendar_event" indexName="idx_cal_event_account">
            <column name="account"/>
        </createIndex>
        <createIndex tableName="calendar_event" indexName="idx_cal_event_date">
            <column name="event_date"/>
        </createIndex>
        <createIndex tableName="calendar_event" indexName="idx_cal_event_account_date">
            <column name="account"/>
            <column name="event_date"/>
        </createIndex>
    </changeSet>

    <!-- 创建提醒表 -->
    <changeSet id="2026-cal-002" author="calendar-app">
        <createTable tableName="calendar_reminder" remarks="提醒表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="event_id" type="BIGINT" remarks="关联事件ID"/>
            <column name="account" type="VARCHAR(50)" remarks="用户账号">
                <constraints nullable="false"/>
            </column>
            <column name="remind_time" type="DATETIME" remarks="提醒时间">
                <constraints nullable="false"/>
            </column>
            <column name="remind_before" type="INT" defaultValue="0" remarks="提前多少分钟提醒"/>
            <column name="notification_type" type="VARCHAR(50)" remarks="通知方式(wechat,sms,dingtalk)"/>
            <column name="status" type="TINYINT" defaultValue="1" remarks="状态: 1-待发送 2-已发送 3-发送失败"/>
            <column name="retry_count" type="INT" defaultValue="0" remarks="重试次数"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="更新时间"/>
            <column name="is_delete" type="TINYINT" defaultValue="0" remarks="删除标记"/>
        </createTable>

        <!-- 添加索引 -->
        <createIndex tableName="calendar_reminder" indexName="idx_cal_reminder_account">
            <column name="account"/>
        </createIndex>
        <createIndex tableName="calendar_reminder" indexName="idx_cal_reminder_time">
            <column name="remind_time"/>
        </createIndex>
        <createIndex tableName="calendar_reminder" indexName="idx_cal_reminder_status">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- 创建周期计划表 -->
    <changeSet id="2026-cal-003" author="calendar-app">
        <createTable tableName="calendar_cycle_plan" remarks="周期计划表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account" type="VARCHAR(50)" remarks="用户账号">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(200)" remarks="计划标题">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="TEXT" remarks="计划内容"/>
            <column name="cycle_type" type="TINYINT" remarks="周期类型: 1-每周 2-每月 3-自定义">
                <constraints nullable="false"/>
            </column>
            <column name="cycle_config" type="VARCHAR(500)" remarks="周期配置(JSON)"/>
            <column name="cron_expression" type="VARCHAR(100)" remarks="Cron表达式(自定义时使用)"/>
            <column name="start_date" type="DATE" remarks="开始日期">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE" remarks="结束日期(可为空,表示永久)"/>
            <column name="notification_type" type="VARCHAR(50)" remarks="通知方式"/>
            <column name="remind_time" type="TIME" remarks="每次提醒的时间点"/>
            <column name="status" type="TINYINT" defaultValue="1" remarks="状态: 1-启用 2-暂停 3-已结束"/>
            <column name="next_trigger_time" type="DATETIME" remarks="下次触发时间"/>
            <column name="last_trigger_time" type="DATETIME" remarks="上次触发时间"/>
            <column name="quartz_job_key" type="VARCHAR(100)" remarks="Quartz任务Key"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="更新时间"/>
            <column name="is_delete" type="TINYINT" defaultValue="0" remarks="删除标记"/>
        </createTable>

        <!-- 添加索引 -->
        <createIndex tableName="calendar_cycle_plan" indexName="idx_cal_cycle_account">
            <column name="account"/>
        </createIndex>
        <createIndex tableName="calendar_cycle_plan" indexName="idx_cal_cycle_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="calendar_cycle_plan" indexName="idx_cal_cycle_next_trigger">
            <column name="next_trigger_time"/>
        </createIndex>
    </changeSet>

    <!-- 创建通知日志表 -->
    <changeSet id="2026-cal-004" author="calendar-app">
        <createTable tableName="calendar_notification_log" remarks="通知日志表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account" type="VARCHAR(50)" remarks="用户账号">
                <constraints nullable="false"/>
            </column>
            <column name="source_type" type="TINYINT" remarks="来源类型: 1-事件提醒 2-周期计划"/>
            <column name="source_id" type="BIGINT" remarks="来源ID"/>
            <column name="notification_type" type="VARCHAR(20)" remarks="通知类型"/>
            <column name="title" type="VARCHAR(200)" remarks="通知标题"/>
            <column name="content" type="TEXT" remarks="通知内容"/>
            <column name="status" type="TINYINT" remarks="状态: 1-成功 2-失败"/>
            <column name="error_message" type="TEXT" remarks="错误信息"/>
            <column name="send_time" type="DATETIME" remarks="发送时间"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
        </createTable>

        <!-- 添加索引 -->
        <createIndex tableName="calendar_notification_log" indexName="idx_cal_notif_account">
            <column name="account"/>
        </createIndex>
        <createIndex tableName="calendar_notification_log" indexName="idx_cal_notif_source">
            <column name="source_type"/>
            <column name="source_id"/>
        </createIndex>
    </changeSet>

    <!-- 创建通知方式配置表 -->
    <changeSet id="2026-cal-005" author="calendar-app">
        <createTable tableName="calendar_notification_method" remarks="通知方式配置表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)" remarks="通知方式编码">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(100)" remarks="通知方式名称">
                <constraints nullable="false"/>
            </column>
            <column name="icon" type="VARCHAR(50)" remarks="图标"/>
            <column name="description" type="VARCHAR(500)" remarks="描述"/>
            <column name="impl_status" type="TINYINT" defaultValue="0" remarks="实现状态: 0-未实现 1-已实现"/>
            <column name="sort_order" type="INT" defaultValue="0" remarks="排序"/>
            <column name="status" type="TINYINT" defaultValue="1" remarks="状态: 1-启用 0-禁用"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
            <column name="update_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="更新时间"/>
        </createTable>

        <!-- 插入预定义的通知方式 -->
        <insert tableName="calendar_notification_method">
            <column name="code" value="app"/>
            <column name="name" value="应用内通知"/>
            <column name="icon" value="Bell"/>
            <column name="description" value="在应用页面顶部显示通知"/>
            <column name="impl_status" value="1"/>
            <column name="sort_order" value="1"/>
            <column name="status" value="1"/>
        </insert>
        <insert tableName="calendar_notification_method">
            <column name="code" value="wechat"/>
            <column name="name" value="微信公众号"/>
            <column name="icon" value="ChatDotRound"/>
            <column name="description" value="通过微信公众号推送通知"/>
            <column name="impl_status" value="0"/>
            <column name="sort_order" value="2"/>
            <column name="status" value="1"/>
        </insert>
        <insert tableName="calendar_notification_method">
            <column name="code" value="dingtalk"/>
            <column name="name" value="钉钉"/>
            <column name="icon" value="ChatLineSquare"/>
            <column name="description" value="通过钉钉机器人推送通知"/>
            <column name="impl_status" value="0"/>
            <column name="sort_order" value="3"/>
            <column name="status" value="1"/>
        </insert>
        <insert tableName="calendar_notification_method">
            <column name="code" value="sms"/>
            <column name="name" value="短信"/>
            <column name="icon" value="Iphone"/>
            <column name="description" value="通过短信发送通知"/>
            <column name="impl_status" value="0"/>
            <column name="sort_order" value="4"/>
            <column name="status" value="1"/>
        </insert>
    </changeSet>

    <!-- 为事件表添加心情字段 -->
    <changeSet id="2026-cal-006" author="calendar-app">
        <addColumn tableName="calendar_event">
            <column name="mood" type="VARCHAR(50)" remarks="心情(emoji或文字)" afterColumn="priority"/>
        </addColumn>
    </changeSet>

    <!-- 为提醒表添加标题字段 -->
    <changeSet id="2026-cal-007" author="calendar-app">
        <addColumn tableName="calendar_reminder">
            <column name="title" type="VARCHAR(20)" remarks="提醒标题(不超过20字)" afterColumn="event_id"/>
        </addColumn>
    </changeSet>

    <!-- 创建应用内通知表 -->
    <changeSet id="2026-cal-008" author="calendar-app">
        <createTable tableName="calendar_app_notification" remarks="应用内通知表">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="account" type="VARCHAR(50)" remarks="用户账号">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(20)" remarks="通知标题">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="VARCHAR(200)" remarks="通知内容"/>
            <column name="remind_time" type="DATETIME" remarks="提醒时间">
                <constraints nullable="false"/>
            </column>
            <column name="source_type" type="TINYINT" remarks="来源: 1-事件提醒 2-周期计划"/>
            <column name="source_id" type="BIGINT" remarks="来源ID"/>
            <column name="is_read" type="TINYINT" defaultValue="0" remarks="是否已读: 0-否 1-是"/>
            <column name="create_time" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP" remarks="创建时间"/>
        </createTable>

        <createIndex tableName="calendar_app_notification" indexName="idx_cal_app_notif_account">
            <column name="account"/>
        </createIndex>
        <createIndex tableName="calendar_app_notification" indexName="idx_cal_app_notif_time">
            <column name="remind_time"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
